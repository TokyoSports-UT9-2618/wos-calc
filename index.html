<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ホワサバ集結計算機 Ver1.7</title>
    <style>
        /* --- デザイン設定 (CSS) --- */
        :root {
            --primary-color: #007AFF;
            --bg-color: #F2F2F7;
            --card-color: #FFFFFF;
            --text-color: #1C1C1E;
            --danger-color: #FF3B30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* 入力エリア */
        .leader-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        input[type="text"],
        input[type="number"],
        input[type="tel"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            /* iOSの影を消す */
        }

        .name-input {
            flex: 2;
        }

        .sec-input {
            flex: 1;
        }

        .unit {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
        }

        /* ボタン類 */
        button {
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        button:active {
            opacity: 0.7;
        }

        .add-btn {
            width: 100%;
            padding: 10px;
            background-color: #E5E5EA;
            color: #007AFF;
            border-radius: 8px;
            font-size: 18px;
        }

        .rally-options,
        .delay-options {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .rally-btn,
        .delay-btn {
            flex: 1;
            padding: 12px 0;
            border-radius: 8px;
            background-color: #E5E5EA;
            color: #000;
            font-size: 14px;
        }

        .rally-btn.active {
            background-color: #E1F0FF;
            color: #007AFF;
            border: 2px solid #007AFF;
        }

        .calc-area {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .action-btn {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 8px;
            white-space: nowrap;
        }

        /* 結果表示 */
        #result-box {
            background-color: #E9ECEF;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            min-height: 100px;
            cursor: pointer;
        }

        .copy-hint {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* アラート */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* 言語切り替えボタン */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            cursor: pointer;
            color: #007AFF;
            font-weight: bold;
        }

        /* 言語切り替えボタン */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            cursor: pointer;
            color: #007AFF;
            font-weight: bold;
        }

        /* カスタムメッセージ入力 */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div class="container" style="position:relative;">
        <div class="lang-switch" onclick="toggleLang()">[JP] / [EN]</div>
        <h1 data-i18n="title">集結時間計算機</h1>

        <div class="card" id="leaders-container">
        </div>
        <button class="add-btn" onclick="addLeaderRow()" data-i18n="addReader">＋ リーダー追加</button>

        <br><br>

        <div class="card">
            <div style="margin-bottom:10px; font-weight:bold; font-size:14px; color:#555;" data-i18n="rallyTime">集結時間
            </div>
            <div class="rally-options">
                <button class="rally-btn active" onclick="selectRally(1, this)" data-i18n="rally1m">1分集結</button>
                <button class="rally-btn" onclick="selectRally(5, this)" data-i18n="rally5m">5分集結</button>
                <button class="rally-btn" onclick="selectRally(10, this)" data-i18n="rally10m">10分集結</button>
            </div>
        </div>

        <div class="card">
            <div style="font-weight:bold; margin-bottom:5px;" data-i18n="calcFromTarget">① 着弾時間から計算</div>
            <div class="calc-area">
                <input type="text" id="targetTime" placeholder="例 18:45:00" style="text-align:center; font-size:18px;">
                <button class="action-btn" onclick="calcFromTarget()" data-i18n="calcAndCopy">計算＆コピー</button>
            </div>
        </div>

        <div class="card">
            <div style="font-weight:bold; margin-bottom:10px;" data-i18n="calcFromDelay">② ○秒後スタートで計算</div>
            <div class="delay-options">
                <button class="delay-btn" onclick="calcFromDelay(30)" data-i18n="delay30s">30秒後</button>
                <button class="delay-btn" onclick="calcFromDelay(60)" data-i18n="delay60s">60秒後</button>
                <button class="delay-btn" onclick="calcFromDelay(90)" data-i18n="delay90s">90秒後</button>
            </div>
        </div>

        <div class="card">
            <div style="font-weight:bold; margin-bottom:5px;" data-i18n="customMsgLabel">カスタムメッセージ（任意）</div>
            <textarea id="customMessage" placeholder="追加メッセージ（任意・最大100文字）" maxlength="100" rows="3"
                oninput="saveCustomMessage()"></textarea>
        </div>

        <div class="card">
            <div class="copy-hint" data-i18n="tapToCopy">タップしてコピー</div>
            <div id="result-box" onclick="copyResult()" data-i18n="resultPlaceholder">計算結果がここに表示されます</div>
        </div>
    </div>

    <div id="toast" data-i18n="toastCopy">コピーしました！</div>

    <script>
        // --- データ管理 ---
        let leaders = [];
        let selectedRallyMin = 1;
        let currentLang = 'ja'; // デフォルト

        const translations = {
            ja: {
                title: "集結時間計算機",
                addReader: "＋ リーダー追加",
                rallyTime: "集結時間",
                rally1m: "1分集結",
                rally5m: "5分集結",
                rally10m: "10分集結",
                calcFromTarget: "① 着弾時間から計算",
                calcAndCopy: "計算＆コピー",
                calcFromDelay: "② ○秒後スタートで計算",
                delay30s: "30秒後",
                delay60s: "60秒後",
                delay90s: "90秒後",
                customMsgLabel: "カスタムメッセージ（任意）",
                tapToCopy: "タップしてコピー",
                resultPlaceholder: "計算結果がここに表示されます",
                toastCopy: "コピーしました！",
                leaderNamePlaceholder: "リーダー名",
                timeRemaining: "残り時間",
                secUnit: "秒"
            },
            en: {
                title: "Larry Time Calculator",
                addReader: "+ Add Leader",
                rallyTime: "Rally Time",
                rally1m: "1m Rally",
                rally5m: "5m Rally",
                rally10m: "10m Rally",
                calcFromTarget: "① Calc from Landing Time",
                calcAndCopy: "Calculate & Copy",
                calcFromDelay: "② Calc from Delay Start",
                delay30s: "30s After",
                delay60s: "60s After",
                delay90s: "90s After",
                customMsgLabel: "Custom Message",
                tapToCopy: "Tap to Copy",
                resultPlaceholder: "Calculation result will be shown here",
                toastCopy: "Copied to clipboard!",
                leaderNamePlaceholder: "Leader Name",
                timeRemaining: "Time Remaining",
                secUnit: "sec"
            }
        };

        // 起動時の処理
        // 起動時の処理
        window.onload = function () {
            initLanguage();
            loadLeaders();
            renderLeaders();
            loadCustomMessage(); // カスタムメッセージ復元
        };

        // --- リーダー操作 ---
        function loadLeaders() {
            const saved = localStorage.getItem('wos_leaders');
            if (saved) {
                try {
                    leaders = JSON.parse(saved);
                } catch (e) {
                    leaders = [];
                }
            }

            // ★修正済み：データがない、または空の場合は強制的に5行作る
            if (!leaders || leaders.length === 0) {
                leaders = [];
                for (let i = 0; i < 5; i++) {
                    leaders.push({ name: "", sec: "" });
                }
            }
        }

        function saveLeaders() {
            // 現在のDOMから値を取得して配列とストレージを更新
            const rows = document.querySelectorAll('.leader-row');
            leaders = [];
            rows.forEach(row => {
                const name = row.querySelector('.name-input').value;
                const sec = row.querySelector('.sec-input').value;
                leaders.push({ name: name, sec: sec });
            });
            localStorage.setItem('wos_leaders', JSON.stringify(leaders));
        }

        function renderLeaders() {
            const container = document.getElementById('leaders-container');
            container.innerHTML = '';
            leaders.forEach((leader, index) => {
                const div = document.createElement('div');
                div.className = 'leader-row';
                div.innerHTML = `
                <input type="text" class="name-input" placeholder="${t('leaderNamePlaceholder')}" value="${leader.name}" oninput="saveLeaders()">
                <div class="unit">${t('timeRemaining')}</div>
                <input type="tel" class="sec-input" placeholder="${t('secUnit')}" value="${leader.sec}" oninput="saveLeaders()">
                <div class="unit">${t('secUnit')}</div>
            `;
                container.appendChild(div);
            });
        }

        // --- 言語設定・切り替え ---
        function initLanguage() {
            const savedLang = localStorage.getItem('wos_lang');
            if (savedLang) {
                currentLang = savedLang;
            } else {
                // ブラウザの言語設定を確認
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('en')) {
                    currentLang = 'en';
                } else {
                    currentLang = 'ja';
                }
            }
            updateLanguageUI();
        }

        function toggleLang() {
            currentLang = (currentLang === 'ja') ? 'en' : 'ja';
            localStorage.setItem('wos_lang', currentLang);
            updateLanguageUI();
            renderLeaders(); // リーダー入力欄のプレースホルダー更新のため再描画
        }

        function updateLanguageUI() {
            // data-i18n 属性を持つ要素を一括更新
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.innerText = translations[currentLang][key];
                }
            });

            // プレースホルダーの更新 (TargetTime, CustomMessage)
            // ※TargetTime は固有なのでここで変更
            const targetTimeInput = document.getElementById('targetTime');
            if (currentLang === 'en') {
                targetTimeInput.placeholder = "Ex. 18:45:00";
                document.getElementById('customMessage').placeholder = "Additional message (Optional, Max 100 chars)";
            } else {
                targetTimeInput.placeholder = "例 18:45:00";
                document.getElementById('customMessage').placeholder = "追加メッセージ（任意・最大100文字）";
            }
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function addLeaderRow() {
            // ★修正済み：追加前に保存することでデータ消失を防ぐ
            saveLeaders();
            leaders.push({ name: "", sec: "" });
            localStorage.setItem('wos_leaders', JSON.stringify(leaders));
            renderLeaders();
        }

        // --- カスタムメッセージ保存・復元 ---
        function saveCustomMessage() {
            const msg = document.getElementById('customMessage').value;
            localStorage.setItem('wos_custom_message', msg);
        }

        function loadCustomMessage() {
            const msg = localStorage.getItem('wos_custom_message');
            if (msg) {
                document.getElementById('customMessage').value = msg;
            }
        }

        // --- 集結時間選択 ---
        function selectRally(min, btn) {
            selectedRallyMin = min;
            document.querySelectorAll('.rally-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- 計算ロジック共通 ---
        function getActiveLeaders() {
            return leaders.filter(l => l.name.trim() !== "" && l.sec !== "");
        }

        function formatName(name) {
            const trimmed = name.trim();
            return trimmed.length > 3 ? trimmed.substring(0, 3) : trimmed;
        }

        function formatTime(date) {
            const m = date.getMinutes().toString().padStart(2, '0');
            const s = date.getSeconds().toString().padStart(2, '0');
            // i18n対応
            if (currentLang === 'en') {
                return `${m}m${s}s`;
            }
            return `${m}分${s}秒`;
        }

        function formatLandingTime(date) {
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            const s = date.getSeconds().toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function showResult(text) {
            document.getElementById('result-box').innerText = text;
            copyResult();
        }

        // --- 計算1：着弾時間指定 ---
        function calcFromTarget() {
            saveLeaders();
            const inputStr = document.getElementById('targetTime').value;
            const targetDate = parseTimeInput(inputStr);

            if (!targetDate) {
                alert("時間は HH:mm:ss 形式で入力してください\n例：18:45:00");
                return;
            }

            const active = getActiveLeaders();
            if (active.length === 0) {
                alert("リーダー名と秒数を入力してください");
                return;
            }

            const rallySec = selectedRallyMin * 60;
            // i18n対応ヘッダー
            let output = (currentLang === 'en')
                ? `${selectedRallyMin}m Rally\n`
                : `${selectedRallyMin}分集結\n`;

            active.forEach(l => {
                const dist = parseInt(l.sec);
                const startTimestamp = targetDate.getTime() - (dist * 1000) - (rallySec * 1000);
                const startDate = new Date(startTimestamp);

                // 秒の単位もi18n
                const secUnit = (currentLang === 'en') ? 's' : '秒';
                output += `${formatName(l.name)}（${l.sec}${secUnit}）　${formatTime(startDate)}\n`;
            });

            // i18n対応着弾時間
            const landingLabel = (currentLang === 'en') ? "Landing Time" : "着弾時間";
            output += `\n${landingLabel} ${formatLandingTime(targetDate)}`;

            // カスタムメッセージ追加
            const customMsg = document.getElementById('customMessage').value;
            if (customMsg) {
                output += `\n\n${customMsg}`;
            }

            // 固定フッター追加
            output += `\n\n※UT9@2618: The ultimate alliance for your WOS life!`;

            showResult(output);
        }

        function parseTimeInput(str) {
            const parts = str.split(/[:：]/).map(Number);
            if (parts.length < 2 || parts.some(isNaN)) return null;

            const now = new Date();
            const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (parts.length === 3) {
                d.setHours(parts[0], parts[1], parts[2]);
            } else if (parts.length === 2) {
                d.setHours(parts[0], parts[1], 0);
            }
            return d;
        }

        // --- 計算2：遅延スタート ---
        function calcFromDelay(delaySec) {
            saveLeaders();
            const active = getActiveLeaders();
            if (active.length === 0) {
                alert("リーダー名と秒数を入力してください");
                return;
            }

            const distances = active.map(l => parseInt(l.sec));
            const minDist = Math.min(...distances);

            const now = new Date();
            const baseStartTime = new Date(now.getTime() + delaySec * 1000);
            const rallySec = selectedRallyMin * 60;
            const landingTime = new Date(baseStartTime.getTime() + (rallySec * 1000) + (minDist * 1000));

            let output = (currentLang === 'en')
                ? `${selectedRallyMin}m Rally\n`
                : `${selectedRallyMin}分集結\n`;

            active.forEach(l => {
                const dist = parseInt(l.sec);
                const diff = dist - minDist;
                const myStart = new Date(baseStartTime.getTime() - (diff * 1000));

                const secUnit = (currentLang === 'en') ? 's' : '秒';
                output += `${formatName(l.name)}（${l.sec}${secUnit}）　${formatTime(myStart)}\n`;
            });

            const landingLabel = (currentLang === 'en') ? "Landing Time" : "着弾時間";
            output += `\n${landingLabel} ${formatLandingTime(landingTime)}`;

            // カスタムメッセージ追加
            const customMsg = document.getElementById('customMessage').value;
            if (customMsg) {
                output += `\n\n${customMsg}`;
            }

            // 固定フッター追加
            output += `\n\n※UT9@2618: The ultimate alliance for your WOS life!`;

            showResult(output);
        }

        // --- クリップボードコピー ---
        function copyResult() {
            const text = document.getElementById('result-box').innerText;
            if (!text || text === "計算結果がここに表示されます") return;

            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById("toast");
                toast.className = "show";
                setTimeout(function () { toast.className = toast.className.replace("show", ""); }, 3000);
            }).catch(err => {
                alert("コピーに失敗しました。手動でコピーしてください。");
            });
        }
    </script>

</body>

</html>